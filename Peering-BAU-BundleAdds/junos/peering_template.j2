{% set node = nodes[inventory_hostname] %}

{% if node.lag_id_2 != None %}
This Peering Bundle config is for {{ node.jira }} in {{ inventory_hostname }} for {{ node.name|upper }} with capacity AE{{node.lag_id_1}}-{{ node.lag_bw_1 }}G and AE{{node.lag_id_2}}-{{ node.lag_bw_2 }}G
{% else %}
This Peering Bundle config is for {{ node.jira }} in {{ inventory_hostname }} for {{ node.name|upper }} with capacity AE{{node.lag_id_1}}-{{ node.lag_bw_1 }}G
{% endif %}

!CHANGE SPECIFIC PRE-CHECKS BELOW!

Router Name: {{ inventory_hostname }}

{% if node.lag_id_1 != None %}
show interfaces ae{{ node.lag_id_1 }}
show lacp interfaces ae{{ node.lag_id_1 }}
!Expected Output : Check be{{ node.lag_id_1 }} existing links
{% else %}
{% endif %}

{% if node.lag_id_2 != None %}
show interfaces ae{{ node.lag_id_2 }}
show lacp interfaces ae{{ node.lag_id_2 }} 
!Expected Output : Check be{{ node.lag_id_2 }} existing links
{% else %}
{% endif %}

{% if node.lag_id_1 != None %}
{% for intf,intf_attr in node.lag_id_1_links.items()|sort %}
show interfaces {{ intf }}
show interfaces diagnostics optics {{ intf }} | match dBm | except threshold

{% endfor %}
!Expected Output: link light level should be good
{% else %}
{% endif %}

{% if node.lag_id_2 != None %}
{% for intf,intf_attr in node.lag_id_2_links.items()|sort %}
show interfaces {{ intf }}
show interfaces diagnostics optics {{ intf }} | match dBm | except threshold

{% endfor %}
!Expected Output: link light level should be good
{% else %}
{% endif %}


!CHANGE SPECIFIC CONFIGURATIONS BELOW!

START

Router Name: {{ inventory_hostname }}


{% if node.lag_id_1 != None %}

!Interface Config LAG1!

set interfaces ae{{ node.lag_id_1 }} description "[TYPE={{ node.type }}][BW={{ node.lag_bw_1 }}G][NAME={{ node.name|upper }}][AS={{ node.bgp.remote_as }}][IP={{ node.bgp.peer_ipv4_1 }}]"

{% for intf, intf_attr in node.lag_id_1_links.items()|sort %}
set interfaces {{ intf }} description "[TYPE={{node.type}}][BW={{ intf_attr.int_bw }}G][NAME={{ node.name|upper }}][AS={{ node.bgp.remote_as }}][LAG={{ node.lag_id_1 }}][GRNT={{ intf_attr.int_grnt }}][JIRA={{ node.jira }}][CCID={{ intf_attr.ccid }}][PCID={{ intf_attr.pcid }}]"
set interfaces {{ intf }} hold-time up 500
set interfaces {{ intf }} hold-time down 0
set interfaces {{ intf }} damping half-life 1
set interfaces {{ intf }} damping max-suppress 4
set interfaces {{ intf }} damping reuse 750
set interfaces {{ intf }} damping suppress 2000
set interfaces {{ intf }} damping enable
set interfaces {{ intf }} gigether-options 802.3ad ae{{ node.lag_id_1 }}

{% endfor %}
{% else %}
{% endif %}


{% if node.lag_id_2 != None %}    

!Interface Config LAG2!

set interfaces ae{{ node.lag_id_2 }} description "[TYPE={{ node.type }}][BW={{ node.lag_bw_2 }}G][NAME={{ node.name|upper }}][AS={{ node.bgp.remote_as }}][IP={{ node.bgp.peer_ipv4_2 }}]"

{% for intf, intf_attr in node.lag_id_2_links.items()|sort %}
set interfaces {{ intf }} description "[TYPE={{node.type}}][BW={{ intf_attr.int_bw }}G][NAME={{ node.name|upper }}][AS={{ node.bgp.remote_as }}][LAG={{ node.lag_id_2 }}][GRNT={{ intf_attr.int_grnt }}][JIRA={{ node.jira }}][CCID={{ intf_attr.ccid }}][PCID={{ intf_attr.pcid }}]"
set interfaces {{ intf }} hold-time up 500
set interfaces {{ intf }} hold-time down 0
set interfaces {{ intf }} damping half-life 1
set interfaces {{ intf }} damping max-suppress 4
set interfaces {{ intf }} damping reuse 750
set interfaces {{ intf }} damping suppress 2000
set interfaces {{ intf }} damping enable
set interfaces {{ intf }} gigether-options 802.3ad ae{{ node.lag_id_2 }}

{% endfor %}
{% else %}
{% endif %}

END


!CHANGE SPECIFIC POST-CHECKS BELOW!

Router Name: {{ inventory_hostname }}

{% if node.lag_id_1 != None %}
show int ae{{ node.lag_id_1 }}
show lacp interfaces ae{{ node.lag_id_1 }}
!Expected Output : Check ae{{ node.lag_id_1 }} has the new links active in the bundle
{% else %}
{% endif %}

{% if node.lag_id_2 != None %}
show int ae{{ node.lag_id_2 }}
show lacp interfaces ae{{ node.lag_id_2 }}
!Expected Output : Check ae{{ node.lag_id_2 }} has the new links active in the bundle
{% else %}
{% endif %}

{% if node.lag_id_1 != None %}
{% for intf,intf_attr in node.lag_id_1_links.items()|sort %}
show interfaces {{ intf }}
show interfaces {{ intf }} extensive | match err
{% endfor %}
!Expected Output: no errors to be seen!
{% else %}
{% endif %}

{% if node.lag_id_2 != None %}   
{% for intf,intf_attr in node.lag_id_2_links.items()|sort %}
show interfaces {{ intf }}
show interfaces {{ intf }} extensive | match err
{% endfor %}
!Expected Output: no errors to be seen!
{% else %}
{% endif %}
